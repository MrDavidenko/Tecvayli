<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Tecvayli Monitor (NL)</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#2196f3">
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica,Arial,sans-serif;margin:0;background:#fafafa;color:#111}
    header{background:#2196f3;color:#fff;padding:14px 16px;box-shadow:0 2px 6px rgba(0,0,0,.1);position:sticky;top:0;z-index:10}
    h1{font-size:20px;margin:0}
    main{padding:12px 14px;max-width:900px;margin:0 auto}
    .card{background:#fff;border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:12px 14px;margin:10px 0}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    label{font-weight:600;font-size:14px}
    input,select,button,textarea{font:inherit;padding:10px;border:1px solid #ddd;border-radius:10px;background:#fff;min-width:0}
    input[type=time]{width:140px}
    button{background:#2196f3;color:#fff;border:none;cursor:pointer}
    button.secondary{background:#eee;color:#111;border:1px solid #ddd}
    .grid{display:grid;gap:8px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .muted{color:#666;font-size:12px}
    .warn{color:#b00020;font-weight:700}
    .ok{color:#0f7b0f;font-weight:700}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #eee;padding:8px;text-align:left;font-size:14px}
    th{background:#f5f5f5}
    .chip{display:inline-block;background:#e3f2fd;color:#0d47a1;padding:4px 8px;border-radius:999px;font-size:12px;margin-right:6px}
    .footer{font-size:12px;color:#555;margin:14px 4px 24px}
  </style>
</head>
<body>
  <header><h1>TECVAYLI® – Thuismonitoring (NL)</h1></header>
  <main>
    <div class="card">
      <div class="row">
        <div class="grid cols-3" style="flex:1">
          <div><label>Dosis</label><br>
            <select id="dose">
              <option>0,06 mg/kg – Step-up 1</option>
              <option>0,30 mg/kg – Step-up 2</option>
              <option>0,80 mg/kg – Eerste volledige dosis</option>
            </select>
          </div>
          <div><label>Tijdstip toediening (T)</label><br><input id="t0" type="time"></div>
          <div><label>Datum</label><br><input id="date" type="date"></div>
        </div>
        <div>
          <label>&nbsp;</label><br>
          <button id="planBtn">Maak 48u schema</button>
          <button id="clearBtn" class="secondary">Wis data</button>
        </div>
      </div>
      <p class="muted">Hoogrisico: 48 uur na dosis (vaak start symptomen ~1–2 dagen na T). Bewaar deze app op je beginscherm voor snelle toegang.</p>
    </div>

    <div class="card">
      <h3>SEH-triggers (CRS/ICANS)</h3>
      <p>
        <span class="chip">Koorts ≥38,5 °C (aanhoudend ondanks paracetamol)</span>
        <span class="chip">SpO₂ &lt;94% in rust</span>
        <span class="chip">Systolisch &lt;90 mmHg of ≥30 mmHg daling + klachten</span>
        <span class="chip">Benauwdheid/blauwverkleuring</span>
        <span class="chip">Verwardheid/spraakstoornis/insult</span>
        <span class="chip">Hevige verergering of anafylaxie</span>
      </p>
      <p class="muted">Ga bij twijfel direct naar de SEH of bel 112.</p>
    </div>

    <div id="schedule"></div>

    <div class="card">
      <h3>Notities / Medicatie</h3>
      <div class="grid cols-2">
        <div>
          <label>Paracetamol</label><br>
          <textarea id="para" rows="3" placeholder="Bijv. 1000 mg om 14:00 en 22:00"></textarea>
        </div>
        <div>
          <label>Antihistaminicum / Steroïd</label><br>
          <textarea id="anti" rows="3" placeholder="Bijv. loratadine 10 mg, prednisolon 100 mg (met tijden)"></textarea>
        </div>
      </div>
      <br>
      <button id="saveBtn">Opslaan</button>
      <span id="saveMsg" class="muted"></span>
    </div>

    <div class="footer">
      Deze tool is informatief en vervangt geen medisch advies. Volg het plan van je arts. © Tecvayli Monitor (NL)
    </div>
  </main>

  <script>
    const scheduleEl = document.getElementById('schedule');
    const planBtn = document.getElementById('planBtn');
    const clearBtn = document.getElementById('clearBtn');
    const saveBtn = document.getElementById('saveBtn');
    const saveMsg = document.getElementById('saveMsg');

    function fmt(dt){return dt.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
    function addHours(dt, h){ let d=new Date(dt); d.setHours(d.getHours()+h); return d; }

    function mkRow(label, key){
      return (
        '<tr>'+
        '<td>'+label+'</td>'+
        '<td><input data-k="'+key+'-time" type="time"></td>'+
        '<td><input data-k="'+key+'-temp" type="number" step="0.1" placeholder="°C"></td>'+
        '<td><input data-k="'+key+'-spo2" type="number" step="1" placeholder="%"></td>'+
        '<td><input data-k="'+key+'-bps" type="text" placeholder="bijv. 118/75"></td>'+
        '<td><input data-k="'+key+'-bps2" type="text" placeholder="bijv. 110/70"></td>'+
        '<td><input data-k="'+key+'-pulse" type="number" step="1" placeholder="bpm"></td>'+
        '<td><input data-k="'+key+'-fluids" type="number" step="50" placeholder="mL"></td>'+
        '<td><input data-k="'+key+'-sym" type="text" placeholder="klachten/notities"></td>'+
        '</tr>'
      );
    }

    function buildTable(title, time){
      const key = title.replace(/[^a-z0-9]+/gi,'-').toLowerCase();
      return (
        '<div class="card">'+
        '<h3>'+title+'</h3>'+
        '<table>'+
        '<thead><tr><th>Moment</th><th>Tijd</th><th>Temp</th><th>SpO₂</th><th>BP zittend</th><th>BP staand</th><th>Pols</th><th>Vocht</th><th>Klachten</th></tr></thead>'+
        '<tbody>'+ mkRow('Metingen', key) +'</tbody></table>'+
        '<p class="muted">Let op: ga naar de SEH bij drempelwaarden hierboven. Noteer paracetamol en andere medicatie in het vak hieronder.</p>'+
        '</div>'
      );
    }

    function plan(){
      const tStr = document.getElementById('t0').value;
      const dStr = document.getElementById('date').value;
      if(!tStr || !dStr){ alert('Kies een datum en T-tijdstip.'); return; }
      const [hh,mm] = tStr.split(':').map(Number);
      const base = new Date(dStr+'T'+tStr+':00');

      const slots = [
        {label:'Baseline vóór dosis (T−30–0 min)', t: addHours(base, -0.5)},
        {label:'T + 2 uur', t: addHours(base, 2)},
        {label:'T + 6 uur / voor slapengaan', t: addHours(base, 6)},
        {label:'Dag +1 – ochtend', t: addHours(base, 24)},
        {label:'Dag +1 – middag', t: addHours(base, 30)},
        {label:'Dag +1 – avond', t: addHours(base, 36)},
        {label:'Dag +2 – ochtend', t: addHours(base, 48)},
        {label:'Dag +2 – middag', t: addHours(base, 54)},
        {label:'Dag +2 – avond', t: addHours(base, 60)},
      ];

      let html='';
      for(const s of slots){
        html += buildTable(s.label, s.t);
      }
      scheduleEl.innerHTML = html;
      restoreInputs();
      // prefill times
      const inputs = document.querySelectorAll('input[type=time][data-k$="-time"]');
      inputs.forEach((inp, i)=>{
        const tt = slots[i] ? slots[i].t : null;
        if(tt){
          const h = String(tt.getHours()).padStart(2,'0');
          const m = String(tt.getMinutes()).padStart(2,'0');
          inp.value = h+':'+m;
        }
      });
      save();
    }

    function save(){
      const data = {
        dose: document.getElementById('dose').value,
        t0: document.getElementById('t0').value,
        date: document.getElementById('date').value,
        para: document.getElementById('para').value,
        anti: document.getElementById('anti').value,
        fields: {}
      };
      document.querySelectorAll('[data-k]').forEach(el=>{
        data.fields[el.getAttribute('data-k')] = el.value;
      });
      localStorage.setItem('tecvayli-monitor-nl', JSON.stringify(data));
      saveMsg.textContent = "Opgeslagen.";
      setTimeout(()=>saveMsg.textContent="", 1500);
    }

    function restore(){
      const raw = localStorage.getItem('tecvayli-monitor-nl');
      if(!raw) return;
      const data = JSON.parse(raw);
      document.getElementById('dose').value = data.dose || document.getElementById('dose').value;
      document.getElementById('t0').value = data.t0 || "";
      document.getElementById('date').value = data.date || "";
      document.getElementById('para').value = data.para || "";
      document.getElementById('anti').value = data.anti || "";
      if(data.t0 && data.date) plan();
    }

    function restoreInputs(){
      const raw = localStorage.getItem('tecvayli-monitor-nl');
      if(!raw) return;
      const data = JSON.parse(raw);
      document.querySelectorAll('[data-k]').forEach(el=>{
        const k = el.getAttribute('data-k');
        if(data.fields && data.fields[k]!==undefined){ el.value = data.fields[k]; }
        el.addEventListener('change', save);
        el.addEventListener('input', save);
      });
    }

    function clearAll(){
      if(confirm('Alle opgeslagen gegevens wissen?')){
        localStorage.removeItem('tecvayli-monitor-nl');
        location.reload();
      }
    }

    planBtn.addEventListener('click', plan);
    clearBtn.addEventListener('click', clearAll);
    saveBtn.addEventListener('click', save);

    // Register service worker for offline (note: requires HTTPS hosting)
    if('serviceWorker' in navigator){
      window.addEventListener('load', ()=>{
        navigator.serviceWorker.register('./sw.js').catch(()=>{});
      });
    }

    restore();
  </script>
</body>
</html>
