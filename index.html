<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Tecvayli Monitor (NL)</title>
<base href="/Tecvayli/">
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#2196f3">
<style>
  :root{ --primary:#2196f3; --bg:#fafafa; --card:#ffffff; --text:#111; --muted:#666;
         --danger:#b00020; --ok:#0f7b0f; --shadow:0 4px 14px rgba(0,0,0,.08); --radius:16px; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica,Arial,sans-serif}
  header{position:sticky;top:0;z-index:20;background:var(--primary);color:#fff;padding:14px 16px;padding-top:calc(env(safe-area-inset-top) + 12px);box-shadow:var(--shadow)}
  h1{margin:0;font-size:18px}
  main{padding:12px;max-width:900px;margin:0 auto}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin:10px 0}
  .grid{display:grid;gap:10px}
  .cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  @media (max-width:720px){.cols-2,.cols-3{grid-template-columns:1fr}}
  label{display:block;font-weight:700;font-size:14px;margin-bottom:6px}
  input,select,textarea,button{font:inherit;border:1px solid #e5e5e5;border-radius:12px;padding:14px 12px;background:#fff;min-height:48px;width:100%}
  textarea{min-height:110px}
  button{background:var(--primary);color:#fff;border:none;cursor:pointer}
  button.secondary{background:#eef3f8;color:#0d47a1;border:1px solid #d6e6fb}
  .btn-row{display:flex;gap:10px;flex-wrap:wrap}
  .muted{color:#666;font-size:13px}
  .chip{display:inline-block;background:#e3f2fd;color:#0d47a1;padding:8px 10px;border-radius:999px;font-size:12px;margin:4px 6px 0 0}
  .section-title{font-size:16px;margin:0 0 8px 0}
  .measure-card{border:1px solid #efefef;border-radius:14px;padding:12px;background:#fff}
  .measure-grid{display:grid;gap:10px;grid-template-columns:repeat(2,minmax(0,1fr))}
  @media(max-width:560px){.measure-grid{grid-template-columns:1fr}}
  .toolbar{position:sticky;bottom:0;z-index:30;background:#fff;padding:12px 10px;padding-bottom:calc(env(safe-area-inset-bottom) + 12px);box-shadow:0 -4px 14px rgba(0,0,0,.08);display:flex;gap:10px}
  .tool{flex:1}
</style>
</head>
<body>
<header><h1>TECVAYLI¬Æ ‚Äì Thuismonitoring</h1></header>

<main>
  <div class="card">
    <div class="grid cols-3">
      <div><label for="dose">Dosis</label>
        <select id="dose">
          <option>0,06 mg/kg ‚Äì Step-up 1</option>
          <option>0,30 mg/kg ‚Äì Step-up 2</option>
          <option>0,80 mg/kg ‚Äì Eerste volledige dosis</option>
        </select>
      </div>
      <div><label for="t0">Tijdstip toediening (T)</label><input id="t0" type="time"></div>
      <div><label for="date">Datum</label><input id="date" type="date"></div>
    </div>
    <div class="btn-row" style="margin-top:8px">
      <button id="planBtn" type="button" onclick="__app&&__app.plan()">üìÖ Maak 48u schema</button>
      <button id="clearBtn" class="secondary" type="button" onclick="__app&&__app.clearAll()">üßπ Wissen</button>
    </div>
    <p class="muted" style="margin-top:8px">Hoogrisico: 48 uur na dosis (symptomen starten vaak ~1‚Äì2 dagen na T). Zet op beginscherm voor snelle toegang.</p>
  </div>

  <div class="card">
    <h3 class="section-title">SEH-triggers (CRS/ICANS)</h3>
    <div>
      <span class="chip">Koorts ‚â•38,5 ¬∞C (ondanks paracetamol)</span>
      <span class="chip">SpO‚ÇÇ &lt;94% in rust</span>
      <span class="chip">Systolisch &lt;90 mmHg of ‚â•30 mmHg daling + klachten</span>
      <span class="chip">Benauwdheid / blauwverkleuring</span>
      <span class="chip">Verwardheid / spraakstoornis / insult</span>
      <span class="chip">Hevige verergering of anafylaxie</span>
    </div>
    <p class="muted">Ga bij twijfel direct naar de SEH (112 bij nood).</p>
  </div>

  <div id="schedule" aria-live="polite"></div>

  <div class="card">
    <h3 class="section-title">Notities & Medicatie</h3>
    <div class="grid cols-2">
      <div><label for="para">Paracetamol</label><textarea id="para" placeholder="Bijv. 1000 mg om 14:00 en 22:00"></textarea></div>
      <div><label for="anti">Antihistaminicum / Stero√Ød</label><textarea id="anti" placeholder="Bijv. loratadine 10 mg, prednisolon 100 mg (met tijden)"></textarea></div>
    </div>
    <div class="btn-row" style="margin-top:10px">
      <button id="saveBtn" type="button" onclick="__app&&__app.save()">üíæ Opslaan</button>
      <button id="exportBtn" class="secondary" type="button" onclick="__app&&__app.exportData()">‚¨áÔ∏è Exporteer gegevens</button>
    </div>
    <p id="saveMsg" class="muted" role="status" aria-live="polite"></p>
  </div>
</main>

<div class="toolbar">
  <button class="tool" id="nowBtn" type="button" onclick="__app&&__app.logNow()">üïí Log nu</button>
  <button class="tool" id="checkBtn" type="button" onclick="__app&&__app.sehCheck()">‚úÖ SEH-check</button>
  <button class="tool" id="installBtn" type="button" onclick="__app&&__app.install()">‚ûï Installeer</button>
</div>

<script>
  // Defensive app namespace
  window.__app = (function(){
    const KEY='tecvayli-monitor-nl-v24';
    let deferredPrompt=null;

    function q(id){return document.getElementById(id)}
    function qs(sel){return document.querySelector(sel)}
    function qsa(sel){return Array.from(document.querySelectorAll(sel))}
    function exists(id){const el=q(id); if(!el) console.error('Element ontbreekt:', id); return !!el;}

    function addHours(d,h){const x=new Date(d); x.setHours(x.getHours()+h); return x;}
    function hhmm(d){return String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0');}

    function mkMeasureCard(title, key, timeVal){
      return `
        <div class="card measure-card" data-key="${key}">
          <h3 class="section-title">${title}</h3>
          <div class="measure-grid">
            <div><label>Tijd</label><input type="time" data-k="${key}-time" value="${timeVal||''}"></div>
            <div><label>Temperatuur (¬∞C)</label><input type="number" step="0.1" inputmode="decimal" data-k="${key}-temp" placeholder="bijv. 38.1"></div>
            <div><label>SpO‚ÇÇ (%)</label><input type="number" step="1" inputmode="numeric" data-k="${key}-spo2" placeholder="bijv. 97"></div>
            <div><label>Pols (bpm)</label><input type="number" step="1" inputmode="numeric" data-k="${key}-pulse" placeholder="bijv. 88"></div>
            <div><label>BP zittend (mmHg)</label><input type="text" inputmode="numeric" data-k="${key}-bps" placeholder="bijv. 118/75"></div>
            <div><label>BP staand (mmHg)</label><input type="text" inputmode="numeric" data-k="${key}-bps2" placeholder="bijv. 110/70"></div>
            <div class="cols-2" style="grid-column:1/-1">
              <div><label>Vocht (mL)</label><input type="number" step="50" inputmode="numeric" data-k="${key}-fluids" placeholder="bijv. 500"></div>
              <div><label>Klachten / notities</label><input type="text" data-k="${key}-sym" placeholder="bijv. rillingen, duizelig"></div>
            </div>
          </div>
        </div>
      `;
    }

    function restoreInputs(){
      try{
        const raw=localStorage.getItem(KEY);
        const data= raw? JSON.parse(raw): {fields:{}};
        qsa('[data-k]').forEach(el=>{
          const k=el.getAttribute('data-k');
          if(data.fields && data.fields[k]!==undefined){ el.value = data.fields[k]; }
          el.addEventListener('change', save);
          el.addEventListener('input', save);
        });
      }catch(e){ console.error('restoreInputs error', e); }
    }

    function plan(){
      try{
        const tStr=q('t0').value;
        const dStr=q('date').value;
        if(!tStr || !dStr){ alert('Kies een datum en T-tijdstip.'); return; }
        const base=new Date(dStr+'T'+tStr+':00');
        const slots=[
          {label:'Baseline v√≥√≥r dosis (T‚àí30‚Äì0 min)', t:addHours(base,-0.5)},
          {label:'T + 2 uur', t:addHours(base,2)},
          {label:'T + 6 uur / voor slapengaan', t:addHours(base,6)},
          {label:'Dag +1 ‚Äì ochtend', t:addHours(base,24)},
          {label:'Dag +1 ‚Äì middag', t:addHours(base,30)},
          {label:'Dag +1 ‚Äì avond', t:addHours(base,36)},
          {label:'Dag +2 ‚Äì ochtend', t:addHours(base,48)},
          {label:'Dag +2 ‚Äì middag', t:addHours(base,54)},
          {label:'Dag +2 ‚Äì avond', t:addHours(base,60)}
        ];
        let html='';
        for(const s of slots){
          const key=s.label.replace(/[^a-z0-9]+/gi,'-').toLowerCase();
          html+=mkMeasureCard(s.label, key, hhmm(s.t));
        }
        const scheduleEl=q('schedule');
        scheduleEl.innerHTML=html;
        restoreInputs();
        save();
      }catch(e){ console.error('plan error', e); alert('Er ging iets mis bij het maken van het schema. Probeer opnieuw.'); }
    }

    function save(){
      try{
        const data={
          dose: q('dose')?.value || '',
          t0: q('t0')?.value || '',
          date: q('date')?.value || '',
          para: q('para')?.value || '',
          anti: q('anti')?.value || '',
          fields:{}
        };
        qsa('[data-k]').forEach(el=>{
          data.fields[el.getAttribute('data-k')]=el.value;
        });
        localStorage.setItem(KEY, JSON.stringify(data));
        const sm=q('saveMsg'); if(sm){ sm.textContent='Opgeslagen.'; setTimeout(()=>{sm.textContent='';},1500); }
      }catch(e){ console.error('save error', e); }
    }

    function exportData(){
      try{
        const raw=localStorage.getItem(KEY) or '{}'
      }catch(e){ console.error('export error', e); }
      const raw2=localStorage.getItem(KEY) or '{}'
    }

    function exportData(){
      try{
        const raw=localStorage.getItem(KEY) || '{}';
        const blob=new Blob([raw], {type:'application/json'});
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a');
        a.href=url; a.download='tecvayli-monitor-data.json'; a.click();
        URL.revokeObjectURL(url);
      }catch(e){ console.error('exportData error', e); }
    }

    function clearAll(){
      try{
        if(confirm('Alle opgeslagen gegevens wissen?')){
          localStorage.removeItem(KEY); location.reload();
        }
      }catch(e){ console.error('clearAll error', e); }
    }

    function logNow(){
      try{
        const inputs=qsa('[data-k$="-time"]');
        if(!inputs.length){ alert('Maak eerst het 48u schema.'); return; }
        const now=new Date();
        const hh=String(now.getHours()).padStart(2,'0');
        const mm=String(now.getMinutes()).padStart(2,'0');
        const empty=inputs.find(i=>!i.value) || inputs[inputs.length-1];
        empty.value=hh+':'+mm; save();
      }catch(e){ console.error('logNow error', e); }
    }

    function sehCheck(){
      try{
        const arr=qsa('[data-k$="-temp"]');
        const arr2=qsa('[data-k$="-spo2"]');
        const temp = arr.length ? parseFloat(arr[arr.length-1].value||'') : NaN;
        const spo2 = arr2.length ? parseInt(arr2[arr2.length-1].value||'',10) : NaN;
        let alerts=[];
        if(!isNaN(temp) && temp>=38.5) alerts.push('Koorts ‚â•38,5 ¬∞C');
        if(!isNaN(spo2) && spo2<94) alerts.push('SpO‚ÇÇ <94% in rust');
        alert(alerts.length ? ('LET OP\n'+alerts.join('\n')+'\n‚Üí Ga naar de SEH bij twijfel.') : 'Geen directe SEH-trigger gedetecteerd. Bij klachten altijd klinisch beoordelen.');
      }catch(e){ console.error('sehCheck error', e); }
    }

    function install(){
      if(window.__deferredPrompt){
        window.__deferredPrompt.prompt(); window.__deferredPrompt.userChoice.finally(()=>{window.__deferredPrompt=null;});
      }else{
        alert('Open via HTTPS in Chrome om te installeren (of gebruik ‚ãÆ ‚Üí Toevoegen aan beginscherm).');
      }
    }

    function onBeforeInstallPrompt(e){
      e.preventDefault();
      window.__deferredPrompt=e; deferredPrompt=e;
    }

    function registerSW(){
      if('serviceWorker' in navigator){
        window.addEventListener('load', ()=>{
          navigator.serviceWorker.register('sw.js').then(()=>{ /* ok */ }).catch(err=>console.error('SW reg error', err));
        });
      }
    }

    function init(){
      // Basic existence checks
      ['dose','t0','date','planBtn','clearBtn','schedule','para','anti','saveBtn','exportBtn','nowBtn','checkBtn','installBtn','saveMsg'].forEach(exists);
      // Restore and SW
      restore();
      registerSW();
      // add listeners (redundant to inline onclick, double-safe)
      const add=(id,fn)=>{ const el=q(id); if(el){ el.addEventListener('click', fn);} };
      add('planBtn', plan); add('clearBtn', clearAll);
      add('saveBtn', save); add('exportBtn', exportData);
      add('nowBtn', logNow); add('checkBtn', sehCheck); add('installBtn', install);
      window.addEventListener('beforeinstallprompt', onBeforeInstallPrompt);
      console.log('App init OK');
    }

    // Public API
    return { plan, save, exportData, clearAll, logNow, sehCheck, install, init };
  })();

  // DOM ready (defensive)
  (function(){
    if(document.readyState==='complete' || document.readyState==='interactive'){
      setTimeout(()=>{ try{ __app.init(); }catch(e){ console.error('init error (early)', e); } }, 0);
    }else{
      document.addEventListener('DOMContentLoaded', ()=>{ try{ __app.init(); }catch(e){ console.error('init error (DOMContentLoaded)', e); } });
    }
  })();
</script>
</body>
</html>
