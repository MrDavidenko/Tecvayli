<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Tecvayli Monitor (NL)</title>
<base href="/Tecvayli/">
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#2196f3">
<style>
  :root{ --primary:#2196f3; --bg:#fafafa; --card:#ffffff; --text:#111; --muted:#666;
         --danger:#b00020; --ok:#0f7b0f; --shadow:0 4px 14px rgba(0,0,0,.08); --radius:16px; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica,Arial,sans-serif}
  header{position:sticky;top:0;z-index:20;background:var(--primary);color:#fff;padding:14px 16px;padding-top:calc(env(safe-area-inset-top) + 12px);box-shadow:var(--shadow)}
  h1{margin:0;font-size:18px}
  main{padding:12px;max-width:900px;margin:0 auto}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin:10px 0}
  .grid{display:grid;gap:10px}
  .cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  @media (max-width:720px){.cols-2,.cols-3{grid-template-columns:1fr}}
  label{display:block;font-weight:700;font-size:14px;margin-bottom:6px}
  input,select,textarea,button{font:inherit;border:1px solid #e5e5e5;border-radius:12px;padding:14px 12px;background:#fff;min-height:48px;width:100%}
  textarea{min-height:110px}
  button{background:var(--primary);color:#fff;border:none;cursor:pointer}
  button.secondary{background:#eef3f8;color:#0d47a1;border:1px solid #d6e6fb}
  .btn-row{display:flex;gap:10px;flex-wrap:wrap}
  .muted{color:#666;font-size:13px}
  .chip{display:inline-block;background:#e3f2fd;color:#0d47a1;padding:8px 10px;border-radius:999px;font-size:12px;margin:4px 6px 0 0}
  .section-title{font-size:16px;margin:0 0 8px 0}
  .measure-card{border:1px solid #efefef;border-radius:14px;padding:12px;background:#fff}
  .measure-grid{display:grid;gap:10px;grid-template-columns:repeat(2,minmax(0,1fr))}
  @media(max-width:560px){.measure-grid{grid-template-columns:1fr}}
  .toolbar{position:sticky;bottom:0;z-index:30;background:#fff;padding:12px 10px;padding-bottom:calc(env(safe-area-inset-bottom) + 12px);box-shadow:0 -4px 14px rgba(0,0,0,.08);display:flex;gap:10px}
  .tool{flex:1}
  .status{margin:10px 0 0 0}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;font-size:12px}
  .badge.ok{background:#e6f4ea;color:#0f7b0f}
  .badge.warn{background:#fdecea;color:#b00020}
  #err{position:fixed;left:0;right:0;bottom:0;background:#b00020;color:#fff;padding:8px 12px;font-size:13px;display:none;z-index:9999}
</style>
</head>
<body>
<header><h1>TECVAYLI¬Æ ‚Äì Thuismonitoring</h1></header>

<main>
  <div class="card">
    <div class="grid cols-3">
      <div><label for="dose">Dosis</label>
        <select id="dose">
          <option>0,06 mg/kg ‚Äì Step-up 1</option>
          <option>0,30 mg/kg ‚Äì Step-up 2</option>
          <option>0,80 mg/kg ‚Äì Eerste volledige dosis</option>
        </select>
      </div>
      <div><label for="t0">Tijdstip toediening (T)</label><input id="t0" type="time"></div>
      <div><label for="date">Datum</label><input id="date" type="date"></div>
    </div>
    <div class="btn-row" style="margin-top:8px">
      <button id="planBtn" type="button">üìÖ Maak 48u schema</button>
      <button id="clearBtn" class="secondary" type="button">üßπ Wissen</button>
    </div>
    <p class="muted" style="margin-top:8px">Hoogrisico: 48 uur na dosis (symptomen starten vaak ~1‚Äì2 dagen na T). Zet op beginscherm voor snelle toegang.</p>
    <div id="statusLine" class="status"></div>
  </div>

  <div class="card">
    <h3 class="section-title">SEH-triggers (CRS/ICANS)</h3>
    <div>
      <span class="chip">Koorts ‚â•38,5 ¬∞C (ondanks paracetamol)</span>
      <span class="chip">SpO‚ÇÇ &lt;94% in rust</span>
      <span class="chip">Systolisch &lt;90 mmHg</span>
      <span class="chip">Benauwdheid / blauwverkleuring</span>
      <span class="chip">Verwardheid / spraakstoornis / insult</span>
      <span class="chip">Hevige verergering of anafylaxie</span>
    </div>
    <p class="muted">Ga bij twijfel direct naar de SEH (112 bij nood).</p>
  </div>

  <div id="schedule" aria-live="polite"></div>

  <div class="card">
    <h3 class="section-title">Notities & Medicatie</h3>
    <div class="grid cols-2">
      <div><label for="para">Paracetamol</label><textarea id="para" placeholder="Bijv. 1000 mg om 14:00 en 22:00"></textarea></div>
      <div><label for="anti">Antihistaminicum / Stero√Ød</label><textarea id="anti" placeholder="Bijv. loratadine 10 mg, prednisolon 100 mg (met tijden)"></textarea></div>
    </div>
    <div class="btn-row" style="margin-top:10px">
      <button id="saveBtn" type="button">üíæ Opslaan</button>
      <button id="exportBtn" class="secondary" type="button">‚¨áÔ∏è Exporteer gegevens</button>
    </div>
    <p id="saveMsg" class="muted" role="status" aria-live="polite"></p>
  </div>
</main>

<div class="toolbar">
  <button class="tool" id="nowBtn" type="button">üïí Log nu</button>
  <button class="tool" id="checkBtn" type="button">‚úÖ SEH-check</button>
  <button class="tool" id="installBtn" type="button">‚ûï Installeer</button>
</div>

<div id="err"></div>

<script>
(function(){
  // Global error banner to catch issues that block buttons
  window.onerror = function(msg, src, line, col, err){
    var e = document.getElementById('err');
    if(e){
      e.style.display='block';
      e.textContent = 'Fout: ' + msg + (line?(' @'+line+':' + (col||'')):'');
    }
  };

  var KEY='tecvayli-monitor-nl-v28';
  var deferredPrompt=null;

  function $(sel){ return document.querySelector(sel); }
  function $$(sel){ return Array.prototype.slice.call(document.querySelectorAll(sel)); }
  function byId(id){ return document.getElementById(id); }

  function addHours(d,h){ var x=new Date(d); x.setHours(x.getHours()+h); return x; }
  function hhmm(d){ return String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0'); }
  function toNum(v){ if(v==null) return NaN; var s=String(v).trim().replace(',', '.'); var n = parseFloat(s); return isNaN(n)? NaN : n; }
  function toInt(v){ if(v==null) return NaN; var s=String(v).trim(); var n = parseInt(s, 10); return isNaN(n)? NaN : n; }

  function mkMeasureCard(title, key, timeVal){
    return ''+
      '<div class="card measure-card" data-key="'+key+'">'+
        '<h3 class="section-title">'+title+'</h3>'+
        '<div class="measure-grid">'+
          '<div><label>Tijd</label><input type="time" data-k="'+key+'-time" value="'+(timeVal||'')+'"></div>'+
          '<div><label>Temperatuur (¬∞C)</label><input type="text" inputmode="decimal" data-k="'+key+'-temp" placeholder="bijv. 38,1"></div>'+
          '<div><label>SpO‚ÇÇ (%)</label><input type="text" inputmode="numeric" data-k="'+key+'-spo2" placeholder="bijv. 97"></div>'+
          '<div><label>Pols (bpm)</label><input type="text" inputmode="numeric" data-k="'+key+'-pulse" placeholder="bijv. 88"></div>'+
          '<div><label>BP zittend (mmHg)</label><input type="text" inputmode="numeric" data-k="'+key+'-bps" placeholder="bijv. 118/75"></div>'+
          '<div><label>BP staand (mmHg)</label><input type="text" inputmode="numeric" data-k="'+key+'-bps2" placeholder="bijv. 110/70"></div>'+
          '<div class="cols-2" style="grid-column:1/-1">'+
            '<div><label>Vocht (mL)</label><input type="text" inputmode="numeric" data-k="'+key+'-fluids" placeholder="bijv. 500"></div>'+
            '<div><label>Klachten / notities</label><input type="text" data-k="'+key+'-sym" placeholder="bijv. rillingen, duizelig"></div>'+
          '</div>'+
        '</div>'+
      '</div>';
  }

  function save(){
    try{
      var data={
        dose: byId('dose') ? byId('dose').value : '',
        t0: byId('t0') ? byId('t0').value : '',
        date: byId('date') ? byId('date').value : '',
        para: byId('para') ? byId('para').value : '',
        anti: byId('anti') ? byId('anti').value : '',
        fields:{}
      };
      var nodes = $$('[data-k]');
      for(var i=0;i<nodes.length;i++){
        var el=nodes[i];
        data.fields[el.getAttribute('data-k')] = el.value;
      }
      localStorage.setItem(KEY, JSON.stringify(data));
      var sm = byId('saveMsg');
      if(sm){ sm.textContent='Opgeslagen.'; setTimeout(function(){ sm.textContent=''; }, 1500); }
      updateStatus();
    }catch(e){ console.error('save error', e); }
  }

  function loadSaved(){
    try{ var raw=localStorage.getItem(KEY); return raw? JSON.parse(raw): null; }catch(e){ return null; }
  }

  function restoreHeader(saved){
    if(!saved) return;
    if(byId('dose')) byId('dose').value = saved.dose || byId('dose').value;
    if(byId('t0')) byId('t0').value = saved.t0 || '';
    if(byId('date')) byId('date').value = saved.date || '';
    if(byId('para')) byId('para').value = saved.para || '';
    if(byId('anti')) byId('anti').value = saved.anti || '';
  }

  function restoreInputs(saved){
    var data = saved || loadSaved() || {fields:{}};
    var nodes = $$('[data-k]');
    for(var i=0;i<nodes.length;i++){
      var el=nodes[i];
      var k = el.getAttribute('data-k');
      if(data.fields && typeof data.fields[k] !== 'undefined'){ el.value = data.fields[k]; }
      el.addEventListener('change', save);
      el.addEventListener('input', save);
    }
  }

  function plan(fromSaved){
    try{
      var tStr = (fromSaved && fromSaved.t0) ? fromSaved.t0 : (byId('t0') ? byId('t0').value : '');
      var dStr = (fromSaved && fromSaved.date) ? fromSaved.date : (byId('date') ? byId('date').value : '');
      if(!tStr || !dStr){
        if(!fromSaved) alert('Kies een datum en T-tijdstip.');
        return;
      }
      var base = new Date(dStr+'T'+tStr+':00');
      var slots = [
        {label:'Baseline v√≥√≥r dosis (T‚àí30‚Äì0 min)', t:addHours(base,-0.5)},
        {label:'T + 2 uur', t:addHours(base,2)},
        {label:'T + 6 uur / voor slapengaan', t:addHours(base,6)},
        {label:'Dag +1 ‚Äì ochtend', t:addHours(base,24)},
        {label:'Dag +1 ‚Äì middag', t:addHours(base,30)},
        {label:'Dag +1 ‚Äì avond', t:addHours(base,36)},
        {label:'Dag +2 ‚Äì ochtend', t:addHours(base,48)},
        {label:'Dag +2 ‚Äì middag', t:addHours(base,54)},
        {label:'Dag +2 ‚Äì avond', t:addHours(base,60)}
      ];
      var html='';
      for(var i=0;i<slots.length;i++){
        var s=slots[i];
        var key = s.label.replace(/[^a-z0-9]+/gi,'-').toLowerCase();
        html += mkMeasureCard(s.label, key, hhmm(s.t));
      }
      var schedule = byId('schedule');
      schedule.innerHTML = html;
      restoreInputs(fromSaved);
      if(!fromSaved){ save(); }
      updateStatus();
    }catch(e){ console.error('plan error', e); alert('Schema maken mislukte.'); }
  }

  function parseSys(bpStr){
    if(!bpStr) return NaN;
    var s = String(bpStr).trim();
    var m = s.match(/(\d{1,3})\s*\/\s*(\d{1,3})/);
    if(m){ return parseInt(m[1],10); }
    var n = parseInt(s,10);
    return isNaN(n)? NaN : n;
  }

  function pickLatestFilled(){
    var cards = $$('.measure-card');
    var latest = null;
    for(var i=0;i<cards.length;i++){
      var card = cards[i];
      var key = card.getAttribute('data-key');
      var t = (card.querySelector('[data-k="'+key+'-time"]') || {}).value || '';
      var temp = (card.querySelector('[data-k="'+key+'-temp"]') || {}).value || '';
      var spo2 = (card.querySelector('[data-k="'+key+'-spo2"]') || {}).value || '';
      var bps = (card.querySelector('[data-k="'+key+'-bps"]') || {}).value || '';
      var has = (temp && temp.trim()) || (spo2 && spo2.trim()) || (bps && bps.trim());
      if(has){
        latest = { label: (card.querySelector('h3')||{}).textContent || key, time: t, temp: temp, spo2: spo2, bps: bps };
      }
    }
    return latest;
  }

  function sehCheck(){
    var latest = pickLatestFilled();
    if(!latest){ alert('Geen ingevulde meting gevonden. Vul minstens temperatuur of SpO‚ÇÇ in en probeer opnieuw.'); return; }
    var temp = toNum(latest.temp);
    var spo2 = toInt(latest.spo2);
    var sys = parseSys(latest.bps);
    var alerts = [];
    if(!isNaN(temp) && temp >= 38.5) alerts.push('Koorts '+temp.toFixed(1)+' ¬∞C (‚â•38,5)');
    if(!isNaN(spo2) && spo2 < 94) alerts.push('SpO‚ÇÇ '+spo2+'% (<94)');
    if(!isNaN(sys) && sys < 90) alerts.push('Systolisch '+sys+' mmHg (<90)');
    if(alerts.length){
      alert('LET OP ‚Äì mogelijk SEH\nMoment: '+latest.label+(latest.time?(' om '+latest.time):'')+'\n'+alerts.join('\n')+'\n‚Üí Ga naar de SEH bij twijfel.');
    }else{
      alert('Geen directe SEH-trigger gevonden bij: '+latest.label+(latest.time?(' om '+latest.time):'')+'.\nBij klachten altijd klinisch beoordelen.');
    }
  }

  function updateStatus(){
    var latest = pickLatestFilled();
    var el = byId('statusLine');
    if(!el) return;
    if(!latest){ el.innerHTML = '<span class="badge ok">Nog geen ingevulde metingen</span>'; return; }
    var temp = toNum(latest.temp);
    var spo2 = toInt(latest.spo2);
    var sys = parseSys(latest.bps);
    var parts = [];
    if(!isNaN(temp)) parts.push('Temp: '+temp.toFixed(1)+' ¬∞C');
    if(!isNaN(spo2)) parts.push('SpO‚ÇÇ: '+spo2+'%');
    if(!isNaN(sys)) parts.push('SYS: '+sys+' mmHg');
    var warn = (!isNaN(temp)&&temp>=38.5)||(!isNaN(spo2)&&spo2<94)||(!isNaN(sys)&&sys<90);
    el.innerHTML = '<span class="badge '+(warn?'warn':'ok')+'">'+parts.join(' ¬∑ ')+(latest.time?(' ‚Äî '+latest.time):'')+'</span>';
  }

  function exportData(){
    var raw = localStorage.getItem(KEY) || '{}';
    var blob = new Blob([raw], {type:'application/json'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url; a.download = 'tecvayli-monitor-data.json';
    a.click();
    URL.revokeObjectURL(url);
  }

  function logNow(){
    var inputs = $$('[data-k$="-time"]');
    if(!inputs.length){ alert('Maak eerst het 48u schema.'); return; }
    var now = new Date();
    var hh = String(now.getHours()).padStart(2,'0');
    var mm = String(now.getMinutes()).padStart(2,'0');
    var empty = null;
    for(var i=0;i<inputs.length;i++){ if(!inputs[i].value){ empty=inputs[i]; break; } }
    if(!empty) empty = inputs[inputs.length-1];
    empty.value = hh+':'+mm;
    save();
  }

  function clearAll(){
    if(confirm('Alle opgeslagen gegevens wissen?')){
      localStorage.removeItem(KEY);
      location.reload();
    }
  }

  function install(){
    if(deferredPrompt){
      deferredPrompt.prompt();
      deferredPrompt.userChoice.finally(function(){ deferredPrompt=null; });
    }else{
      alert('Open via HTTPS in Chrome om te installeren (of gebruik ‚ãÆ ‚Üí Toevoegen aan beginscherm).');
    }
  }

  function registerSW(){
    if('serviceWorker' in navigator){
      window.addEventListener('load', function(){
        navigator.serviceWorker.register('sw.js').catch(function(err){ console.error('SW reg error', err); });
      });
    }
  }

  function init(){
    try{
      var saved = loadSaved();
      restoreHeader(saved);
      if(saved && saved.t0 && saved.date){ plan(saved); }
      var el;
      if(el=byId('planBtn')) el.addEventListener('click', function(){ plan(); });
      if(el=byId('clearBtn')) el.addEventListener('click', clearAll);
      if(el=byId('saveBtn')) el.addEventListener('click', save);
      if(el=byId('exportBtn')) el.addEventListener('click', exportData);
      if(el=byId('nowBtn')) el.addEventListener('click', logNow);
      if(el=byId('checkBtn')) el.addEventListener('click', sehCheck);
      if(el=byId('installBtn')) el.addEventListener('click', install);
      window.addEventListener('beforeinstallprompt', function(e){ e.preventDefault(); deferredPrompt=e; });
      registerSW();
      console.log('App init OK (v28)');
    }catch(e){
      console.error('init error', e);
      var errb = byId('err'); if(errb){ errb.style.display='block'; errb.textContent='Init-fout: '+(e.message||e); }
    }
  }

  if(document.readyState==='complete' || document.readyState==='interactive'){ setTimeout(init, 0); }
  else{ document.addEventListener('DOMContentLoaded', init); }
})();
</script>
</body>
</html>
